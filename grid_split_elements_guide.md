# 四方连续图片合并元素提取功能使用说明

## 功能介绍

该功能可以将一张四方连续图片复制4次，合并成一张4K大图（2048x2048），然后在这个合并后的大图上提取完整的元素。每个提取出的元素都会以其在原图中的坐标信息命名，方便后续编辑后精确贴回原位置。

## 使用前准备

1. **确保已完成图片去背景处理**
   - 运行过 `图片去背景.bat` 生成了一张透明图和一张蒙版图
   - 这张图片应该是四方连续的

2. **安装额外依赖**
   - 首次使用前需手动安装OpenCV：`pip install opencv-python`
   - 或者直接运行：`pip install opencv-python`

## 使用方法

运行 `4图合并提取元素.bat`：
- 输入一张四方连续透明图片路径
- 自动查找或手动输入对应的蒙版图片路径
- 自动复制4次图片并合并，然后提取元素

### 交互式运行步骤

1. **输入透明图片路径**：拖拽或输入四方连续透明图片的完整路径
2. **确认蒙版图片路径**：系统会自动查找对应的蒙版文件，或手动输入
3. **设置输出目录**：可选择自定义输出目录，默认为 `merged_output`
4. **设置最小面积阈值**：可选择自定义最小元素面积，默认为100像素
5. **开始处理**：系统会自动复制图片、合并、提取元素

### 图片合并规则

```
[原图复制] [原图复制]
[原图复制] [原图复制]
```

- 同一张四方连续图片被复制4次
- 按2x2方式排列，形成2048x2048的大图
- 这样可以完整展示四方连续的图案

## 输出文件说明

处理完成后，会在输出目录中生成以下文件：

```
输出目录/
├── merged_rgba.png              # 合并后的4K透明图 (2048x2048)
├── merged_mask.png              # 合并后的4K蒙版图 (2048x2048)
├── elements/                    # 提取的元素文件夹
│   ├── element_000_orig_x10_y20_w50_h60.png   # 元素文件（原图坐标信息在文件名中）
│   ├── element_001_orig_x100_y150_w80_h90.png
│   └── ...
└── elements_info.txt            # 元素位置信息汇总（包含原图和合并图坐标）
```

### 文件名格式说明

元素文件名格式：`element_{索引}_orig_x{原图X坐标}_y{原图Y坐标}_w{宽度}_h{高度}.png`

- `索引`：元素的序号（000开始）
- `原图X坐标`：元素在原图（1024x1024）中的左上角X坐标
- `原图Y坐标`：元素在原图（1024x1024）中的左上角Y坐标
- `宽度`：元素在原图中的宽度（像素）
- `高度`：元素在原图中的高度（像素）

**重要说明**：文件名中的坐标现在使用原图坐标而不是合并图坐标，这样您可以直接知道元素在原始1024x1024图片中的准确位置。

### 坐标系统说明

本工具提供了两套坐标系统：

1. **原图坐标**（用于文件命名）：
   - 基于原始1024x1024图片的坐标系统
   - 坐标范围：X和Y都在0-1024之间
   - 这是您最关心的坐标，可以直接用于定位元素在原图中的位置

2. **合并图坐标**（记录在info文件中）：
   - 基于2048x2048合并图的坐标系统
   - 主要用于算法内部处理和调试

**优势**：使用原图坐标命名的好处是，您可以直接通过文件名知道每个元素在原图中的确切位置，便于后续的编辑和定位工作。

## 高级选项

### 最小面积阈值
- 默认值：100像素
- 作用：过滤掉面积过小的噪点元素
- 调整建议：如果提取了太多小碎片，可以增大此值

## 使用场景

1. **四方连续贴图元素提取**
   - 从四方连续贴图中提取完整元素
   - 通过复制4次展示完整的连续图案
   - 获取更完整的图案元素

2. **游戏素材制作**
   - 提取游戏贴图中的完整装饰元素
   - 制作可重复使用的素材
   - 保持元素的完整性和连续性

## 注意事项

- 输入图片必须是四方连续的，否则合并后会出现明显的接缝
- 透明图片和蒙版图片的尺寸必须完全一致
- 建议使用1024x1024或更高分辨率的图片以获得更好的效果
